//#include "includes.h"
//#include "time.h"
#include "aoaEstAlgo.h"
#include "clock.h"

cplxInt loadIQ_72[]= {\
    {  -222,   322},{  -376,  -181},{   160,  -492},{   565,   297},{  -430,   551},{  -385,  -261},{    69,  -426},{   609,    46},\
    {  -155,   368},{  -537,   -30},{   250,  -676},{   450,   440},{  -252,   391},{  -603,  -187},{   140,  -171},{  -642,   -90},\
    {   119,    20},{  -506,   227},{   -32,  -103},{  -315,   505},{   -77,   -94},{   -92,   487},{  -252,   -56},{   278,   623},\
    {  -138,   116},{   623,   361},{    -9,   -28},{   389,   144},{   -36,   621},{  -611,    23},{    15,  -183},{  -501,   -31},\
    {   -53,  -242},{  -477,   326},{  -209,    36},{  -104,   383},{  -325,    30},{   -20,   590},{  -101,  -348},{   186,   665},\
    {  -141,    22},{   306,   430},{  -230,   356},{   619,    -3},{  -133,   457},{  -512,  -328},{   102,   -85},{  -601,    79},\
    {   -70,  -103},{  -291,   256},{  -121,  -121},{  -102,   331},{   -61,    36},{   -16,   536},{  -223,   -37},{   178,   593},\
    {  -295,   199},{   416,   193},{  -139,    79},{   535,   130},{  -259,   440},{  -300,  -292},{  -163,   -68},{  -664,    79},\
    {   -48,  -278},{  -586,   378},{    -9,   -38},{  -239,   348},{  -142,   -94},{   -99,   588},{  -162,    -1},{   277,   607},\
    {  -341,    92},{   448,   501},{  -128,   102},{   511,    47},{    25,   463},{  -470,  -147},{   106,  -193},{  -763,    41},\
    {   120,   -53},{  -518,   296},{   -91,   -64},{  -348,   533},{  -111,    91},{  -117,   540},{  -155,    -3},{   302,   493},\
    {   -75,    91},{   211,   402},{   -93,    -6},{   464,   -47},{  -231,   489},{  -395,  -210},{  -178,  -225},{  -420,   -90},\
    {   -34,  -207},{  -267,   244},{  -162,   137},{  -267,   313},{  -124,    51},{    29,   420},{    -5,    50},{   273,   311},\
    {  -117,   214},{   427,   327},{  -253,   324},{   407,   168},{  -191,   458},{  -506,  -187},{   -38,  -206},{  -518,    18},\
    {    -9,   -99},{  -543,   265},{   -37,   -84},{  -470,   559},{   -96,    -2},{   -68,   425},{   -11,   -29},{   134,   450},\
    {  -130,   139},{   677,   274},{   -41,   182},{   466,   -41},{   -71,   546},{  -345,  -248},{   -41,  -252},{  -401,     9},\
    {    38,  -150},{  -464,   347},{    26,   -44},{  -275,   516},{   -69,  -135},{   -90,   483},{  -106,   -14},{   286,   358},\
    {   -41,    11},{   355,   289},{  -120,    54},{   500,   216},{  -129,   468},{  -539,  -165},{   263,  -197},{  -550,   240},\
    {    -8,  -202},{  -422,   273},{  -148,  -198},{  -440,   537},{    75,   -39},{  -105,   598},{  -319,   126},{   240,   558},\
    {  -123,   275},{   306,   238},{  -220,   156},{   699,   228},{  -207,   601},{  -581,  -260},{   187,   -79},{  -586,  -118},\
    {    20,  -123},{  -673,   289},{    10,   -68},{  -457,   563},{  -153,     2},{   -15,   628},{   -46,   109},{    54,   517},\
    {  -133,   176},{   361,   373},{   -48,   205},{   522,   103},{   -37,   527},{  -636,  -215},{   238,  -531},{   508,   319},\
    {  -130,   597},{  -233,  -195},{   171,  -691},{   451,   396},{  -171,   374},{  -545,  -234},{   391,  -480},{   501,   114},\
    {  -244,   542},{  -439,   -11},{   383,  -685},{   379,   191},{  -125,   605},{  -449,  -204},{  -470,   301},{  -507,   -54},\
    {  -300,   270},{  -639,  -334},{  -296,   321},{  -659,   -98},{  -232,   135},{     0,     0},{     0,     0},{     0,     0}
};


cplxInt loadIQ_12[]= {\
    {  -383,   575},{  -426,  -205},{   268,  -526},{   385,   303},{  -278,   536},{  -385,  -293},{   308,  -479},{   445,   420},\
    {  -286,   553},{  -264,  -189},{   192,  -430},{   541,   106},{  -221,   354},{  -306,   -87},{   200,  -617},{   190,   210},\
    {  -538,   200},{    73,  -569},{   352,   258},{  -208,   507},{  -445,  -333},{   336,  -186},{   164,   428},{  -524,  -223},\
    {   245,  -549},{   159,   335},{  -414,    53},{   -40,  -694},{   221,    -4},{  -466,  -241},{   237,  -398},{   174,   499},\
    {  -543,  -135},{    66,  -439},{   479,   106},{  -367,   423},{  -217,  -300},{   547,  -261},{   -14,   318},{  -516,  -246},\
    {   346,  -366},{   137,   362},{  -364,   196},{  -346,  -671},{   146,   128},{  -530,  -254},{   305,  -503},{   192,   611},\
    {  -272,   -26},{   117,  -535},{   501,   215},{  -337,   232},{  -293,  -284},{   429,   -35},{   188,   344},{  -518,   -76},\
    {   174,  -482},{   262,   385},{  -213,   315},{  -156,  -529},{   223,   -52},{  -488,  -404},{   278,  -199},{   284,   469},\
    {  -400,    -6},{    39,  -405},{   407,   -26},{  -236,   369},{  -493,  -420},{   545,  -186},{   -84,   638},{  -638,  -337},\
    {   231,  -451},{   302,   482},{  -386,   166},{    64,  -445},{   169,  -164},{  -500,  -174},{   331,  -570},{   343,   546},\
    {  -482,    79},{   -32,  -532},{   378,   118},{  -206,   597},{  -127,  -335},{   465,  -201},{   286,   533},{  -434,   -37},\
    {   290,  -540},{   366,   325},{  -579,   268},{    57,  -686},{   146,    80},{  -718,  -429},{   199,  -371},{   166,   271},\
    {  -438,   135},{    28,  -607},{   522,   197},{  -321,   501},{  -184,  -466},{   514,   -18},{   198,   594},{  -551,  -190},\
    {   283,  -439},{   291,   575},{  -412,   265},{  -108,  -465},{   369,    53},{  -430,  -377},{    76,  -223},{   293,   609},\
    {  -200,   107},{  -100,  -342},{   237,    71},{  -323,   493},{  -157,  -548},{   516,   -80},{     7,   448},{  -483,   -73},\
    {   182,  -424},{   357,   365},{  -274,   177},{  -138,  -532},{   385,   -22},{  -651,  -335},{   351,  -369},{   347,   407},\
    {  -323,   153},{   126,  -579},{   566,   289},{  -411,   423},{  -152,  -401},{   308,  -224},{   -65,   595},{  -395,   -73},\
    {   369,  -391},{   520,   437},{  -458,   292},{   -37,  -663},{   266,    23},{  -537,    -8},{   408,  -380},{   120,   459},\
    {  -534,   180},{   222,  -477},{   383,    32},{  -102,   403},{  -317,  -242},{   367,  -163},{    21,   319},{  -610,    41},\
    {   281,  -274},{   347,   169},{  -483,   335},{   -31,  -474},{    89,    66},{  -460,   -58},{   243,  -314},{   145,   540},\
    {  -271,   199},{   -89,  -542},{   453,   -22},{  -177,   462},{  -340,  -406},{   489,  -103},{   132,   325},{  -604,   -74},\
    {   109,  -515},{   406,   441},{  -370,   313},{  -232,  -479},{   153,    -1},{  -711,  -257},{    76,  -521},{   399,   255},\
    {  -253,   513},{  -486,  -194},{   238,  -493},{   503,   225},{  -216,   637},{  -414,  -292},{   135,  -452},{   394,   162},\
    {  -344,   405},{  -559,   -57},{   289,  -705},{   344,   375},{   -65,   314},{  -511,  -109},{  -391,   374},{  -508,  -133},\
    {  -365,   346},{  -614,  -264},{  -514,   199},{  -569,  -187},{  -318,    76},{     0,     0},{     0,     0},{     0,     0}
};

cplxInt loadIQ_URA_z18_t58[]= {\
    {  -106,  -488},{   308,   -17},{  -213,   273},{  -207,  -514},{   638,  -110},{  -463,   340},{  -197,  -225},{   434,  -158},\
    {  -176,   626},{  -153,  -511},{   632,   -83},{  -286,   448},{  -281,  -301},{   479,  -288},{   163,   180},{   568,  -315},\
    {  -169,   297},{   466,  -173},{  -209,   141},{   505,   336},{  -218,   485},{  -454,   166},{    36,  -257},{  -482,  -160},\
    {   323,   -13},{  -619,  -257},{   138,  -179},{  -496,  -145},{   403,  -132},{   -41,   596},{  -265,  -199},{    46,   645},\
    {  -149,  -294},{  -133,   637},{   -23,  -118},{  -428,   354},{  -328,  -370},{    78,  -401},{   -45,   112},{   271,  -584},\
    {   139,   211},{   266,  -486},{   173,   200},{   279,  -183},{   242,   224},{  -499,   -41},{   264,  -116},{  -352,  -276},\
    {   -14,    13},{  -455,  -330},{   106,   -57},{  -290,  -467},{   238,  -262},{   608,   -18},{   -55,   -58},{   479,   472},\
    {  -149,    26},{   504,   387},{  -158,   131},{   405,   419},{  -455,    11},{   234,  -365},{    94,   194},{   267,  -541},\
    {   109,   127},{   366,  -575},{    42,    37},{   469,  -249},{   193,   255},{    41,   570},{    84,  -228},{  -442,   454},\
    {   -24,  -279},{  -503,   225},{  -120,   -92},{  -347,   338},{    51,  -585},{   578,   310},{  -207,    18},{   590,   295},\
    {  -203,    69},{   320,   288},{  -140,    22},{   356,   436},{  -391,  -147},{  -387,  -244},{   -37,  -246},{  -308,  -365},\
    {   125,    -8},{  -344,  -429},{   113,  -165},{   -96,  -404},{   511,   172},{  -369,   306},{  -175,   -33},{  -354,   370},\
    {   -88,   -78},{  -485,   273},{   -19,    77},{  -358,    11},{   -84,  -476},{   429,  -382},{    54,   234},{   412,  -366},\
    {    46,   277},{   442,   -92},{   -93,   199},{   480,  -329},{    90,   557},{  -284,  -452},{   455,   -90},{  -187,  -431},\
    {   156,     6},{   -61,  -580},{    40,  -105},{    51,  -476},{   560,  -110},{   211,   482},{  -116,    13},{   179,   679},\
    {  -114,  -123},{   -18,   636},{   -59,  -188},{   101,   620},{  -331,  -191},{   333,  -202},{    69,    49},{   276,   -25},\
    {   141,   130},{   427,    64},{    43,   200},{   452,   214},{    23,   283},{  -484,   221},{  -173,  -279},{  -582,   138},\
    {   142,    16},{  -584,    -7},{     9,    33},{  -587,   -57},{   284,  -375},{    51,   621},{    41,   -33},{    89,   652},\
    {  -183,    13},{   275,   443},{  -219,   -79},{   -84,   373},{  -377,  -141},{  -126,  -508},{   100,     9},{   -29,  -402},\
    {   100,    27},{    53,  -748},{   -42,   130},{   279,  -666},{   330,   435},{  -437,    64},{   -21,   -24},{  -486,   -57},\
    {  -149,   -33},{  -460,   -78},{    60,    -3},{  -389,  -403},{   244,  -292},{   460,  -292},{    41,   454},{   621,    80},\
    {   -42,    20},{   654,   362},{   -68,    16},{   631,   374},{  -509,   211},{    13,  -588},{   434,   342},{  -376,   103},\
    {    97,  -407},{   323,   132},{  -521,   137},{   -88,  -543},{   483,   264},{  -299,   299},{   -68,  -516},{   463,   167},\
    {  -410,   256},{  -124,  -589},{   523,   207},{  -598,   293},{    74,  -577},{   628,     1},{   625,   -17},{   220,   500},\
    {   407,   554},{  -166,   455},{  -218,   388},{  -660,     6},{  -319,     8},{     0,     0},{     0,     0},{     0,     0}
};

void main_aoa_est_test(void)
{
    //--------------------------------------------------------------------
    aoaEstCtx_t aCtx;
    aoaEstRes_t aRes;
    int16 iSample[160];
    int16 qSample[160];
    double lambda = 300/2400.0;//c/freq
    double antDist= 0.056;
    #if 0
    //ReadCplxFile( "iqSample_n35", 160, loadIQ );
    //ReadCplxFile( "iqSample_55_ferr0", 160, loadIQ );
    //ReadCplxFile( "iqSample_55", 160, loadIQ );
    ReadCplxFile( "xx_iqSample", 160, loadIQ );
    #endif
    aCtx.antMode = CTE_AOA_ANT_ULA;
    aCtx.antNum = 8;
    aCtx.swSlot = 2;
    aCtx.antNumCol = 3;
    aCtx.antNumRow = 3;
    aCtx.est.rmfsMM = 21;
    aCtx.est.rmfsNN = 3;
    aCtx.lambda = (uint16_t)(lambda*(1<<12));//c/f
    aCtx.antDist =(uint16_t)(antDist*(1<<12));//antDist
    aCtx.iqCnt=160;

    for(int i=0; i<aCtx.iqCnt; i++)
    {
        iSample[i]=loadIQ_URA_z18_t58[i].I;
        qSample[i]=loadIQ_URA_z18_t58[i].Q;
        //printf("#%d [%d %d ] %d %d - %d %d\n",i,loadIQ[i].I,loadIQ[i].Q,iSample[i],qSample[i]);
    }

    aCtx.iSample=iSample;
    aCtx.qSample=qSample;
//    for(int i=0;i<aCtx.iqCnt;i++)
//    {
//        aCtx.iSample[i],aCtx.qSample[i]);
//    }
    time_cost_dbg_tic();
    aoa_est_uxa(aCtx,&aRes);
    time_cost_dbg_toc("aoa_est_ula");

    while(1);

    #if 0
    //dump estimation result data
    int outData[3];
    outData[0] = aRes.fEst0;
    outData[1] = aRes.fEst1;
    outData[2] = aRes.aEst;
    WriteDecFile( "xx_aRes", sizeof(outData)/sizeof(int), outData );
    #endif
}


